#include <stdio.h>
#include <stm32f10x.h>
#include "LSM303DLH.h"
#include <math.h>
#include <stm32f10x.h>

// Raw data arrays
s16 acc_data[3];
s16 magn_data[3];

void AM_Configuration(void);
void update_data(void);

int main(void) {

	//Initialize the sensor:
    //SystemInit();                                       // Global system initialization
    I2C_DeInit(I2C1);						  			// Deinit I2C1
	I2C_DeInit(I2C2);									// Deinit I2C2
	AM_Configuration();
	//Enter an infinite loop to measure from the sensor
	while(1)
		{
			update_data();
		//Convert Reading to Degrees

		//Apply filter to the data
		}

}

// Initialize Accelerometer/Magnetometer Settings.
void AM_Configuration() {

	// Allocate config and init structs
   	LSM_Acc_ConfigTypeDef acc_conf;
	LSM_Magn_ConfigTypeDef magn_conf;

	LSM303DLH_I2C_Init();						   		// Init I2C bus

	// Initialize Accelerometer Settings
	acc_conf.Power_Mode = LSM_Acc_Lowpower_NormalMode;	// Set Power Mode to normal to use the normal output rate
	acc_conf.ODR = LSM_Acc_ODR_50;				   		// 50 Hz output normal
	acc_conf.Axes_Enable = LSM_Acc_XYZEN;				// Enable XYZ axes
	acc_conf.FS = LSM_Acc_FS_2;							// 2 g full-scale for better precision
	acc_conf.Data_Update = LSM_Acc_BDU_Single;		   	// Single data output s.t. high and lows are changed 
														// at the same time as recommended
	acc_conf.Endianess = LSM_Acc_Big_Endian;	   		// Big Endian for simpler display of values

	LSM303DLH_Acc_Reboot_Cmd();					   		// Reboot memory to make sure it is empty

	LSM303DLH_Acc_Config(&acc_conf);				   	// Configure Accelerometer with all selected values above

	// Initialize Magnetometer Settings
	magn_conf.M_ODR = LSM_Magn_ODR_75;				    // Output Data Rate 75Hz
	magn_conf.Meas_Conf = LSM_Magn_MEASCONF_NORMAL;    	// Normal bias Measurements
	magn_conf.Gain = LSM_Magn_GAIN_1_3;			    	// 1.3 gauss scale
	magn_conf.Mode = LSM_Magn_MODE_CONTINUOS;		   	// Continuous Update

	LSM303DLH_Magn_Config(&magn_conf);					// Configure Magnetometer with all selected values above
}


// Process raw data from peripherals
void update_data() {

	LSM303DLH_Acc_Read_Acc(acc_data);						// Read accelerometer data
	LSM303DLH_Magn_Read_Magn(magn_data);					// Read magnetometer data

			
}

